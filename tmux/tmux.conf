# https://github.com/samoshkin/tmux-config/blob/master/tmux/tmux.conf

# Terminal
# https://gist.github.com/andersevenrud/015e61af2fd264371032763d4ed965b6
set -g default-terminal "tmux-256color"
set -sg terminal-overrides ",*:RGB"

# prefix key
set -g prefix C-b

# clear
unbind K
bind K send-keys -R \; send-keys C-l \; clear-history

# new line shift+enter
set -s extended-keys always
set -s extended-keys-format csi-u
set -as terminal-features 'xterm*:extkeys'

# Set parent terminal title to reflect current window in tmux session 
set -g set-titles on
set -g set-titles-string "#I:#W"

# Start index of window/pane with 1
set -g base-index 1
setw -g pane-base-index 1
# Renumber all windows when any is closed
set -g renumber-windows on

# Enable mouse support for switching panes/windows
# NOTE: This breaks selecting/copying text on OSX
# To select text as expected, hold Option to disable it (iTerm2)
set -g mouse on

# word separators for automatic word selection
setw -g word-separators ' @"=()[]'
setw -ag word-separators "'"

# General status bar settings
set -g status 2
set -g status-interval 2
set-option -g status-position bottom

# Reload tmux configuration 
bind i source-file ~/.config/tmux/tmux.conf\; display-message "Config reloaded"

# Set new window and and panes to open in current directory
bind c new-window -c "#{pane_current_path}"
bind '"' split-window -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# Rename session and window
unbind "\$" # rename-session
unbind ,    # rename-window
bind r command-prompt -I "#{window_name}" "rename-window '%%'"
bind R command-prompt -I "#{session_name}" "rename-session '%%'"
# prevent automatic window rename
# set-window-option -g automatic-rename off

# Navigate panes (prefix + arrow)
bind Up select-pane -U
bind Down select-pane -D
bind Left select-pane -L
bind Right select-pane -R
 
# Navigate windows
bind -r Tab last-window   # cycle thru MRU tabs
unbind [    # paste-buffer
unbind ]
bind -r [ swap-window -t -1\; previous-window
bind -r ] swap-window -t +1\; next-window

# Resize panes (prefix + shift + arrow)
bind -r S-Left resize-pane -L 2
bind -r S-Down resize-pane -D 2
bind -r S-Up resize-pane -U 2
bind -r S-Right resize-pane -R 2

# Allow the arrow key to be used immediately after changing windows
set-option -g repeat-time 1

# Kill pane/window/session shortcuts
bind x confirm-before -p "kill pane? (y/n)" kill-pane
bind X confirm-before -p "kill window? (y/n)" kill-window
bind C-x confirm-before -p "kill other windows? (y/n)" "kill-window -a"
bind Q confirm-before -p "kill-session #S? (y/n)" kill-session

# trigger copy mode by
unbind -n M-Up
unbind -n M-Down
bind -n M-Up copy-mode
bind -n M-Down copy-mode

# Scroll up/down by 1 line, half screen, whole screen
bind -T copy-mode-vi M-Up              send-keys -X scroll-up
bind -T copy-mode-vi M-Down            send-keys -X scroll-down
bind -T copy-mode-vi M-PageUp          send-keys -X halfpage-up
bind -T copy-mode-vi M-PageDown        send-keys -X halfpage-down
# bind -T copy-mode-vi PageUp            send-keys -X page-up
# bind -T copy-mode-vi PageDown          send-keys -X page-down

# When scrolling with mouse wheel
bind -T copy-mode-vi WheelUpPane       select-pane \; send-keys -X -N 1 scroll-up
bind -T copy-mode-vi WheelDownPane     select-pane \; send-keys -X -N 1 scroll-down

## Use vim keybindings in copy mode
setw -g mode-keys vi
set-option -s set-clipboard on
bind P paste-buffer
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
unbind -T copy-mode-vi Enter
# copy-pipe-and-cancel - exit from copy mode
# copy-pipe - stay in copy mode 
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'pbcopy'

# Mouse copy: drag selects and copies on release, double-click selects word and copies
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-no-clear 'pbcopy'
bind-key -T root DoubleClick1Pane select-pane -t = \; copy-mode -M \; send-keys -X select-word \; send-keys -X copy-pipe-no-clear 'pbcopy'
bind-key -T copy-mode-vi DoubleClick1Pane send-keys -X select-word \; send-keys -X copy-pipe-no-clear 'pbcopy'

# List of plugins
# leader (C-b)+I
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'catppuccin/tmux'
# set -g @plugin 'jonmosco/kube-tmux'
set -g @plugin 'tony-sol/tmux-kubectx'


#### catppuccin/tmux
# https://github.com/catppuccin/tmux/blob/main/docs/reference/configuration.md
# https://github.com/catppuccin/tmux/blob/main/docs/reference/status-line.md
# Configure the catppuccin plugin
# set -ogq @catppuccin_flavor "macchiato"
# set -ogq @catppuccin_flavor "latte"
set -ogq @catppuccin_flavor "frappe"
set -ogq @catppuccin_window_status_style "rounded"
set -ogq @catppuccin_window_text " #W"
set -ogq @catppuccin_window_default_text " #W"
set -ogq @catppuccin_window_current_text " #W"
set -ogq @catppuccin_window_status "icon"
set -ogq @catppuccin_window_flags "icon"
set -ogq @catppuccin_window_current_background "#{@thm_mauve}"
set -ogq @catppuccin_pane_status_enabled "yes"
set -ogq @catppuccin_pane_border_status "yes"
# set -ogq @catppuccin_directory_text "#{pane_current_path}"
set -ogq @catppuccin_directory_text "#{=|-80| â€¦;s|$HOME| ~|:pane_current_path}"

#### catppuccin/tmux + jonmosco/kube-tmux
set -ogq @catppuccin_kube_context_color "#{@thm_red}"
set -ogq @catppuccin_kube_namespace_color "#{@thm_sky}"
# Set tmux version information as environment variables
# https://github.com/jonmosco/kube-tmux/blob/master/kube.tmux#L25
# run-shell "tmux set-environment -g KUBE_TMUX_NS_ENABLE false"
# set -ogq update-environment 'KUBE_TMUX_NS_ENABLE'

# load catppuccin theme ...
run "~/.config/tmux/plugins/tmux/catppuccin.tmux"

# Status line layout (two bars, position bottom)
# status-left/right hold the info bar content (expanded via format[1])
set -g status-left-length 100
set -g status-left "#{E:@catppuccin_status_session}#{E:@catppuccin_status_directory}"
set -g status-right-length 100
set -gF status-right "#{E:@catppuccin_status_kube}"
# format[0] (closer to panes): centered window tabs only
set -g 'status-format[0]' '#[list=on align=centre]#[list=left-marker]<#[list=right-marker]>#[list=on]#{W:#[range=window|#{window_index} #{E:window-status-style}#{?#{&&:#{window_last_flag},#{!=:#{E:window-status-last-style},default}}, #{E:window-status-last-style},}#{?#{&&:#{window_bell_flag},#{!=:#{E:window-status-bell-style},default}}, #{E:window-status-bell-style},#{?#{&&:#{||:#{window_activity_flag},#{window_silence_flag}},#{!=:#{E:window-status-activity-style},default}}, #{E:window-status-activity-style},}}]#[push-default]#{T:window-status-format}#[pop-default]#[norange default]#{?loop_last_flag,,#{window-status-separator}},#[range=window|#{window_index} list=focus #{?#{!=:#{E:window-status-current-style},default},#{E:window-status-current-style},#{E:window-status-style}}#{?#{&&:#{window_last_flag},#{!=:#{E:window-status-last-style},default}}, #{E:window-status-last-style},}#{?#{&&:#{window_bell_flag},#{!=:#{E:window-status-bell-style},default}}, #{E:window-status-bell-style},#{?#{&&:#{||:#{window_activity_flag},#{window_silence_flag}},#{!=:#{E:window-status-activity-style},default}}, #{E:window-status-activity-style},}}]#[push-default]#{T:window-status-current-format}#[pop-default]#[norange list=on default]#{?loop_last_flag,,#{window-status-separator}}}#[nolist]'
# format[1] (screen edge): session + directory (left) | k8s context (right)
set -g 'status-format[1]' '#[align=left range=left #{E:status-left-style}]#[push-default]#{T;=/#{status-left-length}:status-left}#[pop-default]#[norange default]#[nolist align=right range=right #{E:status-right-style}]#[push-default]#{T;=/#{status-right-length}:status-right}#[pop-default]#[norange default]'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run "~/.config/tmux/plugins/tpm/tpm"

# override catppuccin bar background to match terminal window
set -g status-style "bg=default"
